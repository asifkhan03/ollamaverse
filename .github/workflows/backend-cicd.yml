name: CI/CD - ollamaverse-backend

on:
  push:
    branches: ["main"]
    paths:
      - "ApplicationCode/backend/**"

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
  K8S_NAMESPACE: ${{ secrets.K8S_NAMESPACE }}
  IMAGE_TAG: ${{ github.sha }}
  IMAGE_NAME: ollamaverse-backend

jobs:
  build-and-deploy:
    runs-on: [self-hosted, Linux, ARM64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin $ECR_REGISTRY

      - name: Build and push Docker image
        run: |
          cd ApplicationCode/backend
          docker buildx build --platform linux/arm64 \
            -t $ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG \
            --push .

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name $EKS_CLUSTER_NAME --region $AWS_REGION

      - name: Deploy to EKS
        run: |
          kubectl set image deployment/ollamaverse-backend \
            ollamaverse-backend=$ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG \
            -n $K8S_NAMESPACE
          
          kubectl rollout status deployment/ollamaverse-backend -n $K8S_NAMESPACE
